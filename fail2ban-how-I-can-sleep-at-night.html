<!DOCTYPE html>
<html>
    <head>
        <title>Matt Camilli</title>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta name="description" content="">
        <meta name="author" content="">
        <link rel="shortcut icon" href="../../docs-assets/ico/favicon.png">  
        <link href="/theme/css/bootstrap.css" rel="stylesheet">
    </head>
    
    <body>
        <div class="container">
            <div class="row">
                <div class="col-lg-8">
                      <h1>Matt Camilli's Blog<small>  It's something</small></h1>
                </div>
                <div class="col-lg-3">
                    <ul class="nav nav-pills" style="padding-top:15px">
                        <li><a href="/">Home</a></li>
                        <li><a href="/about.html">About Me</a></li>
                        <li><a href="https://github.com/mlcamilli" target="_blank">Github</a></li>
                    </ul>
                </div>
            </div>

            <div class="row marketing">
                <div class="col-lg-8">
	 <h2>Fail2ban: How I can sleep at night</h2>
	<h4>Written on 2013-11-09 08:20:00</h4>
	<p><p>It was a casual day at the TrackMaven office when I just so happened to peruse through the logs
on our linode servers. To my dismay I saw a lot of this:</p>
<div class="highlight"><pre><span class="n">reverse</span> <span class="n">mapping</span> <span class="n">checking</span> <span class="n">getaddrinfo</span> <span class="k">for</span> <span class="n">xxx</span><span class="p">.</span><span class="n">xxx</span><span class="p">.</span><span class="n">xx</span><span class="p">.</span><span class="n">xxx</span> <span class="n">failed</span> <span class="o">-</span> <span class="n">POSSIBLE</span> <span class="n">BREAK</span><span class="o">-</span><span class="n">IN</span> <span class="n">ATTEMPT</span><span class="o">!</span>
<span class="nl">input_userauth_request:</span> <span class="n">invalid</span> <span class="n">user</span> <span class="n">admin</span>
<span class="n">Received</span> <span class="n">disconnect</span> <span class="n">from</span> <span class="n">xxx</span><span class="p">.</span><span class="n">xxx</span><span class="p">.</span><span class="n">xx</span><span class="p">.</span><span class="n">xxx</span><span class="o">:</span> <span class="mi">11</span><span class="o">:</span> <span class="n">Bye</span> <span class="n">Bye</span>
<span class="n">Invalid</span> <span class="n">user</span> <span class="n">test1</span> <span class="n">from</span> <span class="n">xxx</span><span class="p">.</span><span class="n">xxx</span><span class="p">.</span><span class="n">xx</span><span class="p">.</span><span class="n">xxx</span>
<span class="n">reverse</span> <span class="n">mapping</span> <span class="n">checking</span> <span class="n">getaddrinfo</span> <span class="k">for</span> <span class="n">xxx</span><span class="p">.</span><span class="n">xxx</span><span class="p">.</span><span class="n">xx</span><span class="p">.</span><span class="n">xxx</span> <span class="n">failed</span> <span class="o">-</span> <span class="n">POSSIBLE</span> <span class="n">BREAK</span><span class="o">-</span><span class="n">IN</span> <span class="n">ATTEMPT</span><span class="o">!</span>
<span class="nl">input_userauth_request:</span> <span class="n">invalid</span> <span class="n">user</span> <span class="n">super</span>
<span class="n">Received</span> <span class="n">disconnect</span> <span class="n">from</span> <span class="n">xxx</span><span class="p">.</span><span class="n">xxx</span><span class="p">.</span><span class="n">xx</span><span class="p">.</span><span class="n">xxx</span><span class="o">:</span> <span class="mi">11</span><span class="o">:</span> <span class="n">Bye</span> <span class="n">Bye</span>
<span class="n">Invalid</span> <span class="n">user</span> <span class="n">test</span> <span class="n">from</span> <span class="n">xxx</span><span class="p">.</span><span class="n">xxx</span><span class="p">.</span><span class="n">xx</span><span class="p">.</span><span class="n">xxx</span>
<span class="n">reverse</span> <span class="n">mapping</span> <span class="n">checking</span> <span class="n">getaddrinfo</span> <span class="k">for</span> <span class="n">xxx</span><span class="p">.</span><span class="n">xxx</span><span class="p">.</span><span class="n">xx</span><span class="p">.</span><span class="n">xxx</span> <span class="n">failed</span> <span class="o">-</span> <span class="n">POSSIBLE</span> <span class="n">BREAK</span><span class="o">-</span><span class="n">IN</span> <span class="n">ATTEMPT</span><span class="o">!</span>
<span class="nl">input_userauth_request:</span> <span class="n">invalid</span> <span class="n">user</span> <span class="n">test</span>
<span class="n">Received</span> <span class="n">disconnect</span> <span class="n">from</span> <span class="n">xxx</span><span class="p">.</span><span class="n">xxx</span><span class="p">.</span><span class="n">xx</span><span class="p">.</span><span class="n">xxx</span><span class="o">:</span> <span class="mi">11</span><span class="o">:</span> <span class="n">Bye</span> <span class="n">Bye</span>
</pre></div>


<p>Wooo someone somewhere had a bot which was trying to gain access to our server; fun stuff.
While I had already secured our SSH via not allowing root login, using key authentication etc. (more instructions <a href="#otherarticle">here</a>)</p>
<p>So to stop this from happening I installed Fail2ban. Fail2ban is a tool that monitors logs and temporarily bans users based on
defined events, which in this case is brute forcing our SSH connection.</p>
<p>To install:</p>
<div class="highlight"><pre><span class="n">sudo</span> <span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">install</span> <span class="n">fail2ban</span>
</pre></div>


<p>The defaults will actually do a lot for you, but some further customization won't hurt either.</p>
<div class="highlight"><pre><span class="n">sudo</span> <span class="n">cp</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">fail2ban</span><span class="o">/</span><span class="n">jail</span><span class="p">.{</span><span class="n">conf</span><span class="p">,</span><span class="n">local</span><span class="p">}</span>
</pre></div>


<p>Run that command to have a customizable config file in which you can add ip's to whitelist (not get banned)
as well as which jails (rules) you want to enable. The rules are arrays of regex lines to look for in particular logs.
When found at a defined frequency, it will temporarily ban the offending IP address. </p>
<p>While the default jail for SSH is great it unfortunately does not prevent preauth attempts (using a not allowed user)</p>
<p>So to fix this you'll need to</p>
<div class="highlight"><pre><span class="n">sudo</span> <span class="n">vim</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">fail2ban</span><span class="o">/</span><span class="n">filter</span><span class="p">.</span><span class="n">d</span><span class="o">/</span><span class="n">sshd</span><span class="p">.</span><span class="n">conf</span>
</pre></div>


<p>And add this line to the failregex = </p>
<div class="highlight"><pre><span class="p">^</span><span class="o">%</span><span class="p">(</span><span class="nx">__prefix_line</span><span class="p">)</span><span class="nx">sReceived</span> <span class="nx">disconnect</span> <span class="nb">from</span> <span class="o">&lt;</span><span class="nb">HOST</span><span class="o">&gt;</span><span class="p">:</span> <span class="mi">11</span><span class="p">:</span> <span class="nx">Bye</span> <span class="nx">Bye</span> <span class="o">\</span><span class="err">[</span><span class="nx">preauth</span><span class="o">\</span><span class="cp">]</span>\s*$
</pre></div>


<p>Restart the server and you are good to go with fail2ban</p>
<div class="highlight"><pre><span class="n">sudo</span> <span class="n">service</span> <span class="n">fail2ban</span> <span class="n">restart</span>
</pre></div>


<p>Now just type this command to see all the people you have banned!</p>
<div class="highlight"><pre><span class="n">sudo</span> <span class="n">iptables</span> <span class="o">-</span><span class="n">L</span>
</pre></div></p>
	<strong>Tags:</strong> <a href="tag/devops.html">devops </a><a href="tag/fail2ban.html">fail2ban </a>	<hr \>
                </div>

                <div class="col-lg-3 well">
                    <img src="/theme/img/upload.png" style="width:100%"></img>
                    <br><br>
                    <p>Software Engineer, Gamer, Cyclist, Bearded Lover</p>
                    <a href="/category/devops.html">DevOps <span class="badge">2</span></a>
                </div>
            </div>

            <div class="footer">
                <p>&copy; Caffeinated Coders 2013</p>
            </div>

        </div> 
    </body>
</html>